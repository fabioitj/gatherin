- name: Build and deploy on EC2
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ubuntu
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      cd /home/ubuntu/gatherin

      echo -e "\033[1;34m🔑 Creating .env file...\033[0m"
      cat > .env <<EOF
      DATABASE_URL=${{ secrets.DATABASE_URL }}
      DATABASE_URL_BACK=${{ secrets.DATABASE_URL_BACK }}
      OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
      NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
      NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
      SKIP_BUILD_STATIC_GENERATION=true
      EOF

      echo -e "\033[1;34m🐘 Starting Postgres...\033[0m"
      docker-compose up -d database
      
      # Wait for database to be ready
      echo -e "\033[1;34m⏳ Waiting for database...\033[0m"
      sleep 10

      echo -e "\033[1;34m📦 Building backend...\033[0m"
      docker-compose build backend

      echo -e "\033[1;34m📦 Building frontend...\033[0m"
      docker-compose build frontend

      echo -e "\033[1;34m🚀 Starting all services...\033[0m"
      docker-compose up -d

      echo -e "\033[1;32m✅ Deploy finished successfully!\033[0m"